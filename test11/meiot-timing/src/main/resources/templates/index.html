<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <style type="text/css">
        #p {
            margin-top: 10%;
            width: 75rem;
        }

    </style>

</head>

<body>
<div id="app">
    <div id="p" class="container-fluid">
        <div class="btn-group" role="group" aria-label="..." >
            <button @click="addTask"  type="button" class="btn btn-primary btn-default" >新增</button>
        </div>
        <p></p>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr class="info">
                    <td>任务名称</td>
                    <td>分组</td>
                    <td>描述</td>
                    <td>状态</td>
                    <td>corn表达式</td>
                    <td>创建时间</td>
                    <td>操作</td>
                </tr>
                </thead>
                <tbody id="tab">
                <tr v-for="item in items" :key="item.jobName">
                    <td>{{item.jobName}}</td>
                    <td>{{item.jobGroup}}</td>
                    <td>{{item.jobDescription}}</td>
                    <td>{{item.jobStatus}}</td>
                    <td>{{item.cronExpression}}</td>
                    <td>{{item.createTime}}</td>
                    <td>
                        <button @click="handleEdit(item)" class="btn btn-primary btn-warning">修改</button>
                        <!--item.jobName,item.jobGroup-->
                        <button @click="deleteItem(item.jobName,item.jobGroup)" type="button" class="btn btn-danger">删除</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <form>
                            <input type="hidden"   class="form-control" id="taskId">
                            <div class="form-group">
                                <label>任务名称</label>
                                <input type="input" v-model="editForm.jobName"  class="form-control" id="jobName">
                            </div>
                            <div class="form-group">
                                <label>分组</label>
                                <input type="input" v-model="editForm.jobGroup"  class="form-control" id="jobGroup">
                            </div>
                            <div class="form-group">
                                <label>描述</label>
                                <input type="input" v-model="editForm.jobDescription"  class="form-control" id="jobDescription">
                            </div>
                            <div class="form-group">
                                <label>状态</label>
                                <input type="input" v-model="editForm.jobStatus"  class="form-control" id="jobStatus">
                            </div>
                            <div class="form-group">
                                <label>corn表达式</label>
                                <input type="input" v-model="editForm.cronExpression" class="form-control" id="cronExpression">
                            </div>
                            <div class="form-group">
                                <label>创建时间</label>
                                <input type="input" v-model="editForm.createTime" class="form-control" id="createTime">
                            </div>

                            <!--<button type="submit" class="btn btn-default">Submit</button>-->
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                        </button>
                        <button type="button" @click="editItem" class="btn btn-primary">
                            提交更改
                        </button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal -->
        </div>


    </div>
</div>


<script type="text/javascript">
    var tab = new Vue({
        el: '#app',
        data: {
            items: [],
            editForm: {
                jobName: null,
                jobGroup: null,
                jobDescription: null,
                jobStatus: null,
                cronExpression: null,
                createTime: null,
            }
        },
        methods: {
            getList() {
                this.items = getByAjax();
            },
            handleEdit: function(row) {
                this.editFormShow(true);
                $("#taskId").val(1);
                $("#jobName").attr("disabled","disabled");
                $("#jobGroup").attr("disabled","disabled");
                Object.assign(this.editForm, row);

            },
            deleteItem: function(jobName, jobGroup) {
                console.log(jobName + ":" + jobGroup);
                deleteJob(jobName, jobGroup);
                this.getList();
            },
            editItem() {
                if($("#taskId").val() == 1){
                    this.editForm["id"]=1;
                }
                // 这里提交应该就行
                saveTask(JSON.stringify(this.editForm));
                //saveTask(JSON.stringify(this.editForm));
                this.editFormShow(false);
                this.getList();
            },
            editFormShow(val) {
                triggerEditModal(val);
            },
            addTask:function () {
                Object.keys(this.editForm).forEach(k=>{
                    this.editForm[k]=undefined;
                })
                $("#taskId").val(0);
                $("#jobName").attr("disabled",false);
                $("#jobGroup").attr("disabled",false);
                this.editFormShow(true);
            }

        },
        created() {
            this.getList();
        }
    })

    function saveTask(data){
        $.ajax({
            //跳转对象，此处指向Controller层的方法
            url: "task/save",
            type: "POST",
            async: false,
            data:data,
            dataType: "json",
            contentType:"application/json",
            success: function(result) {
                console.log(result)
                if (result.msg == "成功") {
                    alert("成功");
                }
            },
            error: function(XMLResponse) {
                //返回失败信息
                alert(" 错误信息：" + XMLResponse.responseText);
            }
        })
    }

    /**
     * 获取列表
     * @returns {Array}
     */
    function getByAjax() {
        var data = []
        $.ajax({
            //跳转对象，此处指向Controller层的方法
            url: "task/list",
            type: "get",
            dataType: "json",
            //返回类型，此处注意，填写json时不能正确解析，应转换为text
            success: function(JsonList) {
                $.each(JsonList.data.rows, function(index, item) {
                    var temp = {};
                    temp["jobName"] = item.jobName;
                    temp["jobGroup"] = item.jobGroup;
                    temp["jobDescription"] = item.jobDescription;
                    temp["jobStatus"] = item.jobStatus;
                    temp["cronExpression"] = item.cronExpression;
                    temp["createTime"] = item.createTime;
                    data.push(temp)
                })
            },
            error: function(XMLResponse) {
                //返回失败信息
                alert(" 错误信息：" + XMLResponse.responseText);
            }
        });
        console.log(data)
        return data;
    }

    /**
     * 删除任务
     */
    function deleteJob(jobName, jobGroup) {
        $.ajax({
            //跳转对象，此处指向Controller层的方法
            url: "task/delete/" + jobName + "/" + jobGroup,
            type: "PUT",
            async: false,
            dataType: "json",
            success: function(result) {
                console.log(result)
                if (result.msg == "成功") {
                    alert("成功");
                }
            },
            error: function(XMLResponse) {
                //返回失败信息
                alert(" 错误信息：" + XMLResponse.responseText);
            }
        })
    }

    /**
     * 触发弹框显示
     */
    function triggerEditModal(isShow) {
        if (isShow) {
            $('#editModal').modal('show');
        } else {
            $('#editModal').modal('hide');
        }
    }
</script>

</body>

</html>