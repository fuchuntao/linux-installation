<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.meiot.dao.TimerModeMapper">


    <select id="queryTimerMode" resultType="cn.meiot.entity.TimerMode">
		SELECT
			id,
			name,
			type,
			times,
			content,
			is_switch AS isSwitch,
			switch_sn AS switchSn
		FROM
			timer_mode
		WHERE
			timer_mode.switch_sn = #{switchSn}
		ORDER BY update_time DESC
	</select>
    <select id="querySn" resultType="java.util.Map">
         SELECT
                timer_mode.id,
                timer_mode.is_switch AS switch,
                timer_mode.name,
                timer_mode.type,
                timer_mode.times,
                timer_mode.content,
                timer_mode.serial_number AS serialNumber,
                COUNT(DISTINCT timer_mode_app_user.switch_sn,0) AS switchCount
        FROM
                timer_mode
        JOIN (
            SELECT
                timer_mode_app_user.timer_mode_id
            FROM
                timer_mode_app_user
            WHERE
                timer_mode_app_user.switch_sn = #{switchSn}
        ) AS t ON timer_mode.id = t.timer_mode_id
        JOIN
                timer_mode_app_user
        ON
                timer_mode.id = timer_mode_app_user.timer_mode_id
        GROUP BY
            timer_mode.id
	</select>
    <select id="querySwitchById" resultType="cn.meiot.entity.PowerAppUser">
		SELECT
            timer_mode_app_user.switch_sn AS switchSn,
            switch.switch_index AS 'index'
        FROM
            `timer_mode_app_user`
        JOIN
            switch
        ON
            timer_mode_app_user.switch_sn = switch.switch_sn
        WHERE
            timer_mode_app_user.timer_mode_id = #{id}
	</select>

    <resultMap id="timemoder" type="cn.meiot.entity.TimerMode">
        <result column="id" property="id"/>
        <result column="times" property="times"/>
        <result column="type" property="type"/>
        <result column="isSwitch" property="isSwitch"/>
        <result column="name" property="name"/>
        <collection property="powerAppUserList" ofType="cn.meiot.entity.PowerAppUser">
            <result column="switch_sn" property="switchSn"/>
            <result column="status" property="status"/>
            <result column="index" property="index"/>
        </collection>
    </resultMap>

    <select id="querySerial" resultMap="timemoder">
      SELECT
        timer_mode.id,
        timer_mode.times,
        timer_mode.type,
        timer_mode.isSwitch,
        timer_mode.`name`,
        timer_mode_app_user.switch_sn,
        timer_mode_app_user.`status`,
        switch.switch_index AS 'index'
    FROM
          (
        SELECT
            timer_mode.id,
            timer_mode.times,
            timer_mode.type,
            timer_mode.is_switch AS isSwitch,
            timer_mode.`name`
        FROM
          timer_mode
        WHERE
            timer_mode.serial_number = #{serialNumber}
        ) timer_mode
    JOIN
        timer_mode_app_user
    ON
        timer_mode.id = timer_mode_app_user.timer_mode_id
    JOIN
        switch
    ON
        timer_mode_app_user.switch_sn = switch.switch_sn
    </select>
    <select id="queryIdBySerial" resultType="java.lang.Long">
        SELECT
            timer_mode.id
        FROM
            timer_mode
        WHERE
            serial_number = #{serialNumber}
        AND
            is_switch = #{status}
    </select>


    <update id="updateIsSwitch">
		UPDATE timer_mode SET is_switch = 0 WHERE	timer_mode.switch_sn = #{switchSn}
	</update>


    <update id="updateInvalidSwitch">
        <foreach collection="ids" item="id"  separator=";">
            UPDATE
                timer_mode_app_user
            SET
                status = 0
            WHERE
                timer_mode_id = #{id}
            AND
                switch_sn IN
            <foreach collection="powerAppUserList" item="powerAppUser" index="index" open="(" close=")" separator=",">
                #{powerAppUser.switchSn}
            </foreach>
        </foreach>
    </update>

    <delete id="deleteByIdAndSwitch">
        DELETE FROM timer_mode_app_user WHERE  timer_mode_id = #{id} AND switch_sn IN
        <foreach collection="powerAppUserList" item="powerAppUser" index="index" open="(" close=")" separator=",">
            #{powerAppUser.switchSn}
        </foreach>
    </delete>

</mapper>